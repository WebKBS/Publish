@{
    ViewData["Title"] = "Main";
}
<div class="content-body">
    <!-- row -->
    <div class="container-fluid">
        <div class="row page-titles mx-0">
            <div class="col-sm-6">
                <div class="welcome-text">
                    <h4 class="font-weight-bold">장비 추가 / 수정</h4>
                </div>
            </div>
            <div class="col-sm-6 p-md-0 justify-content-sm-end mt-2 mt-sm-0 d-flex">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/Home/index">장비대장</a></li>
                    <li class="breadcrumb-item active"><a href="javascript:void(0)">장비 추가 / 수정</a></li>
                </ol>
            </div>
        </div>
        <div class="card">
            <div class="card-header">
                <h4 class="card-title"></h4>
            </div>
            <div class="card-body">
                <div class="table-responsive custom_table">
                    <table class="table table-responsive-sm footer_info">
                        <tbody>
                            <tr>
                                <th>상태</th>
                                <td>
                                    <div class="form-group d-flex m-0">
                                        <select class="form-control col-5">
                                            <option>상태 전체</option>
                                            <option>보유</option>
                                            <option>반출</option>
                                            <option>폐기</option>
                                        </select>
                                    </div>
                                </td>
                                <th>결제방법</th>
                                <td>
                                    <div class="form-group d-flex m-0">
                                        <select class="form-control col-5">
                                            <option>법인 [하나 231-231-3213]</option>
                                        </select>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>구매 개수</th>
                                <td>
                                    <div class="form-group d-flex m-0">
                                        <input type="text" class="form-control col-5">
                                    </div>
                                </td>
                                <th>금액</th>
                                <td>
                                    <div class="form-group d-flex m-0 align-items-end">
                                        <input type="text" class="form-control col-5">
                                        <span class="ml-2">원</span>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>사용 용도</th>
                                <td>
                                    <input type="text" class="form-control" value="">
                                </td>
                                <th>관리 번호</th>
                                <td>
                                    <input type="text" class="form-control input-default">
                                </td>
                            </tr>
                            <tr>
                                <th>보관 설치</th>
                                <td>
                                    <input type="text" class="form-control" value="">
                                </td>
                                <th>관리 담당자</th>
                                <td>
                                    <div class="form-group d-flex m-0">
                                        <select class="form-control col-5">
                                            <option>개발팀 이미영 과장</option>
                                        </select>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>공급처</th>
                                <td>
                                    <div class="form-group d-flex m-0">
                                        <select class="form-control col-5">
                                            <option>㈜크로스쇼크</option>
                                        </select>
                                    </div>
                                </td>
                                <th>관리 담당자</th>
                                <td>
                                    <div class="form-group d-flex m-0">
                                        <select class="form-control col-5">
                                            <option>IITP Ex 비대면 [123-123-232]</option>
                                        </select>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>메모</th>
                                <td colspan="3">
                                    <div class="form-group">
                                        <textarea class="form-control" rows="4"></textarea>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>증빙 서류</th>
                                <td colspan="3">
                                    <div class="custom upload_wrap">
                                        <ul>
                                            <li>
                                                <input id="tax" type="file" hidden accept=".png" />
                                                <label for="tax" class="drop">
                                                    <span class="text_wrap">
                                                        <span class="title">세금 계산서</span>
                                                        <span>Drag & Drop</span>
                                                        <span>640*640 png</span>
                                                    </span>
                                                    <span class="label_img_wrap"></span>
                                                </label>
                                                <button type="button" class="file_delete">
                                                    <span class="line"></span>
                                                    <span class="line"></span>
                                                </button>
                                            </li>
                                            <li>
                                                <input id="specification" type="file" hidden accept=".png" />
                                                <label for="specification">
                                                    <span class="text_wrap">
                                                        <span class="title">거래 명세서</span>
                                                        <span>Drag & Drop</span>
                                                        <span>640*640 png</span>
                                                    </span>
                                                    <span class="label_img_wrap"></span>
                                                </label>
                                                <button type="button" class="file_delete">
                                                    <span class="line"></span>
                                                    <span class="line"></span>
                                                </button>
                                            </li>
                                            <li>
                                                <input type="file" hidden id="estimate" accept=".png, .pdf" />
                                                <label for="estimate">
                                                    <span class="text_wrap">
                                                        <span class="title">견적서</span>
                                                        <span>Drag & Drop</span>
                                                        <span>png or pdf</span>
                                                    </span>
                                                    <span class="label_img_wrap"></span>
                                                </label>
                                                <button type="button" class="file_delete">
                                                    <span class="line"></span>
                                                    <span class="line"></span>
                                                </button>
                                            </li>
                                            <li>
                                                <input id="contract" type="file" hidden accept=".png, .pdf" />
                                                <label for="contract">
                                                    <span class="text_wrap">
                                                        <span class="title">계약서</span>
                                                        <span>Drag & Drop</span>
                                                        <span>png or pdf</span>
                                                    </span>
                                                    <span class="label_img_wrap"></span>
                                                </label>
                                                <button type="button" class="file_delete">
                                                    <span class="line"></span>
                                                    <span class="line"></span>
                                                </button>
                                            </li>
                                            <li>
                                                <input id="equipment" type="file" hidden accept=".png" />
                                                <label for="equipment">
                                                    <span class="text_wrap">
                                                        <span class="title">장비사진</span>
                                                        <span>Drag & Drop</span>
                                                        <span>640*640 png</span>
                                                    </span>
                                                    <span class="label_img_wrap"></span>
                                                </label>
                                                <button type="button" class="file_delete">
                                                    <span class="line"></span>
                                                    <span class="line"></span>
                                                </button>
                                            </li>
                                            <li>
                                                <input id="place" type="file" hidden accept=".png" />
                                                <label for="place">
                                                    <span class="text_wrap">
                                                        <span class="title">설치 장소 사진</span>
                                                        <span>Drag & Drop</span>
                                                        <span>640*640 png</span>
                                                    </span>
                                                    <span class="label_img_wrap"></span>
                                                </label>
                                                <button type="button" class="file_delete">
                                                    <span class="line"></span>
                                                    <span class="line"></span>
                                                </button>
                                            </li>
                                            <li>
                                                <input id="receipt" type="file" hidden accept=".png, .pdf" />
                                                <label for="receipt">
                                                    <span class="text_wrap">
                                                        <span class="title">영수증</span>
                                                        <span>Drag & Drop</span>
                                                        <span>png or pdf</span>
                                                    </span>
                                                    <span class="label_img_wrap"></span>
                                                </label>
                                                <button type="button" class="file_delete">
                                                    <span class="line"></span>
                                                    <span class="line"></span>
                                                </button>
                                            </li>
                                            <li>
                                                <input id="etc" type="file" hidden accept=".png, .pdf" />
                                                <label for="etc">
                                                    <span class="text_wrap">
                                                        <span class="title">기타</span>
                                                        <span>Drag & Drop</span>
                                                        <span>png or pdf</span>
                                                    </span>
                                                    <span class="label_img_wrap"></span>
                                                </label>
                                                <button type="button" class="file_delete">
                                                    <span class="line"></span>
                                                    <span class="line"></span>
                                                </button>
                                            </li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-center">
                    <div>
                        <button type="button" class="btn btn-danger">삭제</button>
                    </div>
                    <div class="ml-auto">
                        <button type="button" class="btn btn-outline-primary">이전</button>
                        <button type="button" class="btn btn-primary">저장</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    const fileInput = document.querySelectorAll('input[type=file]')
    const label = document.querySelectorAll('label');
    const deleteFileBtn = document.querySelectorAll('.file_delete');

    deleteFileBtn.forEach(btn => {
        btn.addEventListener('click', () => {
            const input = btn.parentElement.querySelector('input[type=file]');
            const imgWrap = btn.parentElement.querySelector('.label_img_wrap');
            const textWrap = btn.parentElement.querySelector('.text_wrap');

            input.value = "";
            disabledFalse(input); // 파일 취소시 disabled 해제

            while (imgWrap.firstChild) {
                imgWrap.removeChild(imgWrap.firstChild);
            }

            textWrap.style.display = "flex";
            btn.style.display = "none";
            imgWrap.style.position = "absolute";
            imgWrap.removeAttribute('data-toggle');
            imgWrap.removeAttribute('data-target');
        })
    })

    fileInput.forEach(ev => {
        ev.addEventListener('change', (event) => {
            const files = changeEvent(event);
            handleUpdate(files, event.target);
            disabledTrue(ev); // 파일 추가시 input disabled
        })
    })


    label.forEach(event => {
        event.addEventListener('mouseover', (ev) => {
            ev.preventDefault();
            ev.currentTarget.parentElement.classList.add('on')
        })

        event.addEventListener('mouseout', (ev) => {
            ev.preventDefault();
            ev.currentTarget.parentElement.classList.remove('on')
        })
    })

    document.addEventListener("dragenter", (event) => {
        event.preventDefault();
    });

    document.addEventListener("dragover", (event) => {
        event.preventDefault();

        if (event.target.className === "label_img_wrap") {
            event.target.closest('li').classList.add('on');
        }
    });

    document.addEventListener("dragleave", (event) => {
        event.preventDefault();
        if (event.target.className === "label_img_wrap") {
            event.target.closest('li').classList.remove('on');
        }
    });

    document.addEventListener("drop", (event) => {
        event.preventDefault();
        const files = event.dataTransfer.files;
        if (event.target.className === "label_img_wrap") {
            handleUpdate([...files], event.target);
            event.target.parentElement.previousElementSibling.disabled = true;
        }

    });

    function changeEvent(event) {
        const { target } = event;
        return [...target.files];
    };

    function handleUpdate(fileList, target) {
        fileList.forEach((file) => {
            console.dir(target)
            const reader = new FileReader();
            reader.addEventListener("load", (event) => {
                const preview = createElement(event, file);
                const ele = target.closest('li').querySelector('.label_img_wrap');
                const textWrap = target.closest('li').querySelector('.text_wrap');
                const button = target.closest('li').querySelector('.file_delete');

                if (file.type === "image/png") {
                    button.style.display = "block";
                    textWrap.style.display = "none";
                    ele.style.position = "static";
                    ele.appendChild(preview);
                    for (let i = 1; i < ele.children.length; i++) {
                        ele.children[i].remove();
                    }
                    ele.setAttribute('data-toggle', 'modal');
                    ele.setAttribute('data-target', '.bd-example-modal-lg');

                    expandImage(ele); // 이미지 클릭시 모달 주소 변경해주는 함수
                    return;

                } else if (file.type === "application/pdf") {
                    const createEle = document.createElement('i');
                    createEle.textContent = file.name;
                    button.style.display = "block";
                    textWrap.style.display = "none";
                    ele.style.position = "static";
                    ele.appendChild(createEle);
                    return;
                } else {
                    alert('지정된 파일형식이 아닙니다.');
                }


            });
            reader.readAsDataURL(file);
        });
    };

    const createElement = (e, file) => {
        const fragment = document.createDocumentFragment();
        const img = document.createElement('img');
        img.setAttribute('src', e.target.result);
        img.setAttribute('data-file', file.name);
        fragment.appendChild(img)
        return fragment;
    }

    // disabled True
    function disabledTrue(target) {
        target.disabled = true;
    }

    function disabledFalse(target) {
        target.disabled = false;
    }

    function expandImage(target) {
        //console.log(target.children.length)
        target.addEventListener('click', () => {
            if (target.children.length < 1) {
                return
            }
            const eleChildImage = target.children[0].src;
            document.getElementById('view_image').src = eleChildImage;
        })
    }



    // URL 주소 확인하고 네비게이션 클래스 넣기
    window.addEventListener('DOMContentLoaded', () => {
        const href = window.location.href;

        if (href.includes('Home/IndexPost')) {
            document.querySelector('a[href="/Home/index"]').parentElement.classList.add('mm-active');
        }
    })
</script>


@section PostModal{
    <div class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg" style="max-width: 1024px">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">타이틀</h4>
                    <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                </div>
                <div class="modal-body">
                    <div class="card-body text-center">
                        <img src="" class="w-auto" id="view_image" />
                    </div>
                </div>
                <div class="modal-footer">

                    <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>

                </div>
            </div>
        </div>
    </div>

};

@section Heads{

}

@section Scripts{

}